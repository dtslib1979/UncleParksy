name: ğŸ—ï¸ Build KR TextStory Archive
on:
  push:
    paths:
      - "backup/**"
      - "scripts/**"
      - "archive/index.html"
      - ".github/workflows/build-textstory.yml"
  schedule:
    # Run every 6 hours
    - cron: "0 */6 * * *"
  workflow_dispatch:
    description: "Manually trigger KR TextStory archive build"

jobs:
  build-archive:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: ğŸ“¦ Install dependencies
        run: |
          pip install beautifulsoup4 lxml

      - name: ğŸª Mirror backup to archive
        run: |
          echo "ğŸ”„ Starting backup mirroring process..."
          python scripts/mirror_backup.py

      - name: ğŸ“‹ Generate manifest
        run: |
          echo "ğŸ“‹ Generating archive manifest..."
          python scripts/generate_manifest.py

      - name: ğŸ“Š Archive statistics
        run: |
          echo "ğŸ“Š Archive Statistics:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          if [ -d "archive" ]; then
            # Count HTML files excluding index.html
            archive_count=$(find archive -name "*.html" ! -name "index.html" | wc -l)
            echo "ğŸ“ Archive HTML files: $archive_count"
            
            echo ""
            echo "ğŸ“ Archive files:"
            find archive -name "*.html" ! -name "index.html" -exec basename {} \; | head -5 | while read file; do
              echo "  â€¢ $file"
            done
            
            remaining=$(( $archive_count - 5 ))
            if [ $remaining -gt 0 ]; then
              echo "  ... and $remaining more files"
            fi
          fi
          
          if [ -f "assets/manifest.json" ]; then
            manifest_count=$(jq '.count' assets/manifest.json 2>/dev/null || echo "0")
            echo ""
            echo "ğŸ“„ Manifest entries: $manifest_count"
            
            echo ""
            echo "ğŸ“– Latest entries:"
            jq -r '.items[:3][] | "  â€¢ \(.title) (\(.date // "no date"))"' assets/manifest.json 2>/dev/null || echo "  (no entries found)"
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: ğŸ” Check for changes
        id: changes
        run: |
          if git diff --quiet; then
            echo "No changes detected"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            git status --porcelain
          fi

      - name: ğŸ“¤ Commit and push changes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config --local user.name "ğŸ¤– KR TextStory Bot"
          git config --local user.email "actions@users.noreply.github.com"
          
          git add archive/ assets/manifest.json
          
          # Create detailed commit message
          archive_count=$(find archive -name "*.html" ! -name "index.html" 2>/dev/null | wc -l || echo "0")
          manifest_count=$(jq '.count' assets/manifest.json 2>/dev/null || echo "0")
          
          git commit -m "ğŸ”„ auto: update KR TextStory archive
          
          ğŸ“Š Stats:
          â€¢ Archive files: $archive_count
          â€¢ Manifest entries: $manifest_count
          â€¢ Generated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          
          ğŸ—ï¸ Updated by GitHub Actions"
          
          git push

      - name: âœ… Build complete
        run: |
          echo "ğŸ‰ KR TextStory Archive build completed successfully!"
          echo ""
          echo "ğŸŒ Archive URL: https://parksy.kr/archive/"
          echo "ğŸ“± Mobile-friendly design with Korean particle effects"
          echo "ğŸ´ Treasure scroll cards with random rotations"
          echo "ğŸ“„ Automatic manifest generation and direct file mirroring"
          echo "ğŸ“ Files stored directly in /archive/ folder"
