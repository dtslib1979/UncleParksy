name: Sync /category â†’ _obsidian (RAW + Markdown) - ì¦‰ì‹œ ë™ê¸°í™”

on:
  schedule:
    - cron: "*/15 * * * *"   # 15ë¶„ë§ˆë‹¤ ì¦‰ì‹œ ë™ê¸°í™” (UTC)
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'category/**'
  # ìƒˆë¡œìš´ HTML í˜ì´ì§€ ì—…ë¡œë“œ ì‹œ ì¦‰ì‹œ íŠ¸ë¦¬ê±°
  workflow_run:
    workflows: ["ğŸ—‚ï¸ Category Index Builder"]
    branches: [main]
    types:
      - completed

permissions:
  contents: write
  actions: read

jobs:
  sync:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (with PAT)
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.SELF_PUSH_TOKEN }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name "actions-bot"
          git config --global user.email "actions@users.noreply.github.com"

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y rsync pandoc

      - name: Prep Obsidian folders
        run: |
          mkdir -p _obsidian/_imports/html_raw
          mkdir -p _obsidian/_imports/html_md

      - name: Check for recent changes (ì¦‰ì‹œ ë™ê¸°í™” ìµœì í™”)
        id: check_changes
        run: |
          # ìµœê·¼ 5ë¶„ ë‚´ category í´ë” ë³€ê²½ í™•ì¸
          RECENT_CHANGES=$(find category -name "*.html" -newermt "5 minutes ago" 2>/dev/null | wc -l)
          echo "recent_changes=$RECENT_CHANGES" >> $GITHUB_OUTPUT
          if [ "$RECENT_CHANGES" -gt 0 ]; then
            echo "âœ… ìµœê·¼ ë³€ê²½ì‚¬í•­ ë°œê²¬: $RECENT_CHANGES ê°œ íŒŒì¼"
            echo "force_sync=true" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸ ìµœê·¼ ë³€ê²½ì‚¬í•­ ì—†ìŒ (ì˜ˆì •ëœ ë™ê¸°í™”)"
            echo "force_sync=false" >> $GITHUB_OUTPUT
          fi

      - name: Sync RAW HTML (ì¦‰ì‹œ ë™ê¸°í™”)
        run: |
          if [ -d "category" ]; then
            echo "ğŸš€ ì¦‰ì‹œ ë™ê¸°í™” ì‹œì‘..."
            rsync -av --delete \
              category/blog-transformation \
              category/device-chronicles \
              category/system-configuration \
              category/thought-archaeology \
              category/webappsbook-codex \
              category/webappsbookcast \
              category/writers-path \
              _obsidian/_imports/html_raw/ 2>/dev/null || true
            echo "âœ… RAW HTML ì¦‰ì‹œ ë™ê¸°í™” ì™„ë£Œ"
          else
            echo "âš ï¸ Category folder not found"
          fi

      - name: Convert HTML â†’ Markdown (ì¦‰ì‹œ ë³€í™˜)
        run: |
          echo "ğŸ”„ HTML â†’ Markdown ì¦‰ì‹œ ë³€í™˜ ì‹œì‘..."
          for folder in blog-transformation device-chronicles system-configuration thought-archaeology webappsbook-codex webappsbookcast writers-path; do
            if [ -d "category/$folder" ]; then
              echo "Processing folder: $folder"
              find category/$folder -type f -name "*.html" | while read -r file; do
                rel="${file#category/}"
                outdir="_obsidian/_imports/html_md/$(dirname "$rel")"
                mkdir -p "$outdir"
                pandoc "$file" -f html -t gfm -o "$outdir/$(basename "$rel" .html).md" 2>/dev/null || echo "Failed to convert: $file"
              done
            fi
          done
          echo "âœ… HTML â†’ Markdown ì¦‰ì‹œ ë³€í™˜ ì™„ë£Œ"

      - name: Copy assets (ì¦‰ì‹œ ë³µì‚¬)
        run: |
          if [ -d "category" ]; then
            rsync -av --exclude='*.html' category/ _obsidian/_imports/html_md/ 2>/dev/null || true
            echo "âœ… Assets ì¦‰ì‹œ ë³µì‚¬ ì™„ë£Œ"
          fi

      - name: Commit & Push (ì¦‰ì‹œ ë°˜ì˜)
        env:
          GITHUB_TOKEN: ${{ secrets.SELF_PUSH_TOKEN }}
        run: |
          git add -A
          if ! git diff --cached --quiet; then
            TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
            if [ "${{ steps.check_changes.outputs.force_sync }}" = "true" ]; then
              git commit -m "ğŸš€ ì¦‰ì‹œë™ê¸°í™”: /category â†’ _obsidian/_imports (raw+md) [$TIMESTAMP]"
              echo "âœ… ìƒˆë¡œìš´ HTML í˜ì´ì§€ ì¦‰ì‹œ ë™ê¸°í™” ì™„ë£Œ"
            else
              git commit -m "â° ì˜ˆì •ë™ê¸°í™”: /category â†’ _obsidian/_imports (raw+md) [$TIMESTAMP]"
              echo "âœ… ì˜ˆì •ëœ ë™ê¸°í™” ì™„ë£Œ"
            fi
            git push origin HEAD:main
            echo "âœ… Changes pushed successfully - ì¦‰ì‹œ ë°˜ì˜ë¨"
          else
            echo "â„¹ï¸ No changes to commit"
          fi