{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "source-format",
  "title": "DTSLIB 원석 포맷 (Source Format)",
  "description": "하나의 아이디어가 시스템에 들어오는 최초의 형태",
  "version": "1.0.0",

  "filePattern": "src-{YYYYMMDD}-{sequence}.json",
  "example": "src-20250116-001.json",

  "schema": {
    "type": "object",
    "required": ["id", "createdAt", "input"],
    "properties": {
      "id": {
        "type": "string",
        "pattern": "^src-\\d{8}-\\d{3}$",
        "description": "고유 식별자",
        "example": "src-20250116-001"
      },

      "createdAt": {
        "type": "string",
        "format": "date-time",
        "description": "원석이 던져진 시각"
      },

      "input": {
        "type": "object",
        "description": "입력된 원본 데이터",
        "properties": {
          "type": {
            "type": "string",
            "enum": ["voice", "text", "visual", "mixed"],
            "description": "입력 형태"
          },
          "raw": {
            "type": "string",
            "description": "원본 텍스트 또는 파일 경로"
          },
          "transcription": {
            "type": "string",
            "description": "음성인 경우 변환된 텍스트"
          },
          "attachments": {
            "type": "array",
            "items": { "type": "string" },
            "description": "첨부 파일 경로들"
          }
        },
        "required": ["type", "raw"]
      },

      "emotion": {
        "type": "object",
        "description": "던질 때의 감정 상태 (선택)",
        "properties": {
          "mood": {
            "type": "string",
            "enum": ["excited", "calm", "frustrated", "curious", "urgent", "reflective"]
          },
          "energy": {
            "type": "string",
            "enum": ["high", "medium", "low"]
          }
        }
      },

      "hint": {
        "type": "object",
        "description": "사람이 남긴 힌트 (선택)",
        "properties": {
          "intendedDomain": {
            "type": "string",
            "enum": ["parksy", "eae", "dtslib", "unknown"],
            "description": "의도한 도착지"
          },
          "intendedFormat": {
            "type": "string",
            "enum": ["log", "essay", "theory", "ebook", "webtoon", "video", "audiobook", "unknown"],
            "description": "의도한 최종 형태"
          },
          "tags": {
            "type": "array",
            "items": { "type": "string" },
            "description": "키워드 태그"
          },
          "note": {
            "type": "string",
            "description": "자유 메모"
          }
        }
      },

      "processing": {
        "type": "object",
        "description": "AI 처리 결과 (시스템이 채움)",
        "properties": {
          "status": {
            "type": "string",
            "enum": ["inbox", "queued", "processing", "routed", "published", "archived"],
            "default": "inbox"
          },
          "analysis": {
            "type": "object",
            "properties": {
              "detectedLanguage": { "type": "string" },
              "wordCount": { "type": "integer" },
              "sentiment": { "type": "string" },
              "keywords": { "type": "array", "items": { "type": "string" } },
              "suggestedTitle": { "type": "string" }
            }
          },
          "routing": {
            "type": "object",
            "properties": {
              "domain": {
                "type": "string",
                "enum": ["parksy", "eae", "dtslib"]
              },
              "confidence": {
                "type": "number",
                "minimum": 0,
                "maximum": 1
              },
              "reason": { "type": "string" },
              "suggestedFormats": {
                "type": "array",
                "items": { "type": "string" }
              }
            }
          },
          "processedAt": { "type": "string", "format": "date-time" },
          "processedBy": { "type": "string", "description": "처리한 AI 모델" }
        }
      },

      "output": {
        "type": "object",
        "description": "출력 결과 (배포 후 채움)",
        "properties": {
          "domain": { "type": "string" },
          "format": { "type": "string" },
          "path": { "type": "string", "description": "출력 파일 경로" },
          "url": { "type": "string", "description": "배포된 URL" },
          "publishedAt": { "type": "string", "format": "date-time" }
        }
      },

      "history": {
        "type": "array",
        "description": "상태 변경 기록",
        "items": {
          "type": "object",
          "properties": {
            "timestamp": { "type": "string", "format": "date-time" },
            "action": { "type": "string" },
            "details": { "type": "string" }
          }
        }
      }
    }
  },

  "routingRules": {
    "description": "원석이 어디로 가는지 결정하는 규칙",
    "rules": [
      {
        "id": "rule-parksy-emotion",
        "condition": "emotion.mood in ['frustrated', 'excited'] OR keywords contain ['일상', '오늘', '생각', '느낌']",
        "destination": "parksy",
        "reason": "감정적이거나 개인적인 콘텐츠"
      },
      {
        "id": "rule-eae-structure",
        "condition": "keywords contain ['이론', '방법', '체계', '구조', '프레임워크'] OR hint.intendedFormat == 'theory'",
        "destination": "eae",
        "reason": "구조화/이론화 필요한 콘텐츠"
      },
      {
        "id": "rule-dtslib-product",
        "condition": "hint.intendedFormat in ['ebook', 'webtoon', 'video', 'audiobook'] OR keywords contain ['출판', '강좌', '판매']",
        "destination": "dtslib",
        "reason": "상품화 가능한 콘텐츠"
      },
      {
        "id": "rule-default",
        "condition": "default",
        "destination": "parksy",
        "reason": "기본값: 샘에서 시작"
      }
    ]
  },

  "publishedDefinition": {
    "description": "'출판됐다'의 정의",
    "levels": [
      {
        "level": 1,
        "name": "drafted",
        "definition": "원석이 output/ 폴더에 파일로 생성됨",
        "indicator": "output.path가 존재"
      },
      {
        "level": 2,
        "name": "deployed",
        "definition": "웹에 접근 가능한 URL이 생성됨",
        "indicator": "output.url이 존재"
      },
      {
        "level": 3,
        "name": "distributed",
        "definition": "외부 플랫폼에 배포됨 (YouTube, Amazon 등)",
        "indicator": "output.externalUrls가 존재"
      }
    ],
    "minimumForPublished": 2,
    "note": "level 2 이상이면 '출판됨'으로 간주"
  }
}
