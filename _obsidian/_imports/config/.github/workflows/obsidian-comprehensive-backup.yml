name: ğŸ¯ Obsidian ì¢…í•© ë°±ì—… ì‹œìŠ¤í…œ

on:
  schedule:
    - cron: "0 */2 * * *"    # 2ì‹œê°„ë§ˆë‹¤ ìë™ ë°±ì—…
  workflow_dispatch:         # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  push:
    branches: [ main ]
    paths:
      - 'category/**'
      - 'archive/**'
      - 'backup/**'
      - 'assets/**'

permissions:
  contents: write
  actions: read

jobs:
  comprehensive-backup:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (with PAT)
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.SELF_PUSH_TOKEN }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name "obsidian-backup-bot"
          git config --global user.email "obsidian-backup@users.noreply.github.com"

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install Dependencies
        run: |
          pip install requests feedparser

      - name: ğŸ¯ Run Comprehensive Obsidian Backup
        run: |
          echo "ğŸ¯ ì˜µì‹œë””ì–¸ ì¢…í•© ë°±ì—… ì‹œì‘..."
          python scripts/obsidian_comprehensive_backup.py

      - name: ğŸ“Š Backup Statistics
        run: |
          echo "ğŸ“Š ë°±ì—… í†µê³„:"
          find _obsidian/_imports -type f | wc -l | xargs echo "ì´ íŒŒì¼ ìˆ˜:"
          find _obsidian/_imports -name "*.html" | wc -l | xargs echo "HTML íŒŒì¼:"
          find _obsidian/_imports -name "*.md" | wc -l | xargs echo "Markdown íŒŒì¼:"
          find _obsidian/_imports -name "*.json" | wc -l | xargs echo "JSON íŒŒì¼:"
          
          echo "ğŸ“ ë°±ì—… êµ¬ì¡°:"
          tree _obsidian/_imports -L 2 || ls -la _obsidian/_imports

      - name: ğŸš€ Commit & Push Obsidian Backup
        env:
          GITHUB_TOKEN: ${{ secrets.SELF_PUSH_TOKEN }}
        run: |
          git add _obsidian/_imports/
          if ! git diff --cached --quiet; then
            TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
            TOTAL_FILES=$(find _obsidian/_imports -type f | wc -l)
            git commit -m "ğŸ¯ ì˜µì‹œë””ì–¸ ì¢…í•© ë°±ì—… ì™„ë£Œ: ${TOTAL_FILES}ê°œ íŒŒì¼ [$TIMESTAMP]

            ğŸ“Š ë°±ì—… êµ¬ì„±:
            - Tistory RSS ë°±ì—…
            - Archive HTML íŒŒì¼
            - Category ì›ë³¸ + Markdown ë³€í™˜
            - Assets ë¦¬ì†ŒìŠ¤
            - ë©”íƒ€ë°ì´í„° ë° ì„¤ì •
            
            ğŸ“ ë°±ì—… ìœ„ì¹˜: _obsidian/_imports/
            ğŸ“‹ ìƒì„¸ ì •ë³´: _obsidian/_imports/BACKUP_INDEX.md"
            
            git push origin HEAD:main
            echo "âœ… ì˜µì‹œë””ì–¸ ë°±ì—… ì™„ë£Œ - ì´ ${TOTAL_FILES}ê°œ íŒŒì¼"
          else
            echo "â„¹ï¸ ë°±ì—…í•  ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤"
          fi

      - name: ğŸ“ Backup Summary
        if: always()
        run: |
          echo "ğŸ¯ ===== ì˜µì‹œë””ì–¸ ì¢…í•© ë°±ì—… ì™„ë£Œ ====="
          echo "ğŸ“… ë°±ì—… ì‹œê°„: $(date)"
          echo "ğŸ“ ë°±ì—… ìœ„ì¹˜: _obsidian/_imports/"
          echo "ğŸ“‹ ë°±ì—… ì¸ë±ìŠ¤: _obsidian/_imports/BACKUP_INDEX.md"
          echo "ğŸš€ Obsidianì—ì„œ '_obsidian/_imports' í´ë”ë¥¼ ë³¼íŠ¸ë¡œ ì—´ì–´ë³´ì„¸ìš”!"
          echo ""
          echo "ğŸ’¡ ì‚¬ìš©ë²•:"
          echo "1. Obsidian ì„¤ì¹˜"
          echo "2. '_obsidian/_imports' í´ë”ë¥¼ ë³¼íŠ¸ë¡œ ì—´ê¸°"
          echo "3. ë°±ì—…ëœ ëª¨ë“  ì½˜í…ì¸  íƒìƒ‰ ë° í™œìš©"